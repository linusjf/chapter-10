#!/usr/bin/env bash

######################################################################
# @author      : Linus Fernandes (linusfernandes at gmail dot com)
# @file        : triggerworkflow
# @created     : Tuesday Oct 28, 2025 15:47:52 IST
#
# @description :
######################################################################
set -u
set -e

source ./workflow.sh
source ./secrets.sh
source ./gh.sh

LOCAL_MODE=false
WORKFLOW=""
WORKFLOW_ID=""
WORKFLOW_TRIGGERED=false

trap handle_exit EXIT

function handle_exit() {
  if [[ "$LOCAL_MODE" == false ]] && [[ -n "$WORKFLOW" ]] && [[ -n "$WORKFLOW_ID" ]]; then
    disable_workflow "$owner" "$repo" "$WORKFLOW"
  fi
  if "$WORKFLOW_TRIGGERED"; then
    echo "DON'T FORGET TO DESTROY AZURE RESOURCES WHEN DONE USING terraform destroy"
  fi
}

function show_help() {
  cat << EOF
Usage: $0 [OPTIONS] WORKFLOW_NAME

Trigger a GitHub Actions workflow.

OPTIONS:
  --local     Run the workflow locally using act instead of on GitHub
  --help      Show this help message and exit

ARGUMENTS:
  WORKFLOW_NAME   Name of the workflow file to run (e.g., deploy.yaml)

EXAMPLES:
  $0 deploy.yaml                    # Run deploy.yaml workflow on GitHub
  $0 --local deploy.yaml            # Run deploy.yaml workflow locally with act
  $0 --help                         # Show this help message

EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --local)
      LOCAL_MODE=true
      shift
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      # First non-option argument is the workflow name
      if [[ -z "$WORKFLOW" ]]; then
        WORKFLOW="$1"
        shift
      else
        echo "Unknown option: $1"
        show_help
        exit 1
      fi
      ;;
  esac
done

WORKFLOW_ID="$(get_workflow_id "$WORKFLOW")"
if [[ -z "${WORKFLOW_ID}" ]]; then
  echo "${WORKFLOW} file does not exist." >&2
  list_workflows
  exit 1
fi

function handle_local_workflow() {
  if [[ -z "$WORKFLOW" ]]; then
    echo "❌ Workflow name must be specified as a command line parameter"
    show_help
    exit 1
  fi
  set_common_secrets "local"
  echo "Secrets stored locally in .secrets file"
  echo "Running workflow locally with act..."
  act push --secret-file .secrets
  WORKFLOW_TRIGGERED=true
}

function handle_github_workflow() {
  if [[ -z "$WORKFLOW" ]]; then
    echo "❌ Workflow name must be specified as a command line parameter"
    show_help
    exit 1
  fi

  declare -a owner_repo
  get_owner_and_repo owner_repo
  owner="${owner_repo[0]}"
  repo="${owner_repo[1]}"

  local actions_enabled="$(gh api "/repos/${owner}/${repo}/actions/permissions" | jq -r '.enabled')"
  disabled_manually="disabled_manually"
  if "$actions_enabled"; then
    local state=$(gh api "repos/${owner}/${repo}/actions/workflows/${WORKFLOW_ID}" | jq -r '.state')
    if [[ $state == "$disabled_manually" ]]; then
      enable_workflow "$owner" "$repo" "$WORKFLOW"
    fi

    set_common_secrets "github"
    gh workflow run "$WORKFLOW"
    WORKFLOW_TRIGGERED=true
    echo "Waiting for 90 seconds before disabling workflow..."
    sleep 90
  else
    echo "Actions are not enabled on this repo."
    return 1
  fi
}

if [[ "$LOCAL_MODE" == true ]]; then
  handle_local_workflow
else
  handle_github_workflow
fi
