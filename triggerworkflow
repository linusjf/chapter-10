#!/usr/bin/env bash

######################################################################
# @author      : Linus Fernandes (linusfernandes at gmail dot com)
# @file        : triggerworkflow
# @created     : Tuesday Oct 28, 2025 15:47:52 IST
#
# @description :
######################################################################
set -u
set -e

source ./workflow.sh
source ./setreposecrets.sh
source ./gh.sh

LOCAL_MODE=false
WORKFLOW=""

trap handle_exit EXIT

function handle_exit() {
  if [[ "$LOCAL_MODE" == false ]] && [[ -n "$WORKFLOW" ]]; then
    disable_workflow "$owner" "$repo" "$WORKFLOW"
  fi
  echo "DON'T FORGET TO DESTROY AZURE RESOURCES WHEN DONE USING terraform destroy"
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
  --local)
    LOCAL_MODE=true
    shift
    ;;
  *)
    # First non-option argument is the workflow name
    if [[ -z "$WORKFLOW" ]]; then
      WORKFLOW="$1"
      shift
    else
      echo "Unknown option: $1"
      exit 1
    fi
    ;;
  esac
done

function handle_local_workflow() {
  if [[ -z "$WORKFLOW" ]]; then
    echo "❌ Workflow name must be specified as a command line parameter"
    exit 1
  fi
  set_common_secrets "local"
  echo "Secrets stored locally in .secrets file"
  echo "Running workflow locally with act..."
  act push --secret-file .secrets
}

function handle_github_workflow() {
  if [[ -z "$WORKFLOW" ]]; then
    echo "❌ Workflow name must be specified as a command line parameter"
    exit 1
  fi

  declare -a owner_repo
  get_owner_and_repo owner_repo
  owner="${owner_repo[0]}"
  repo="${owner_repo[1]}"

  local actions_enabled="$(gh api "/repos/${owner}/${repo}/actions/permissions" | jq -r '.enabled')"
  disabled_manually="disabled_manually"
  if "$actions_enabled"; then
    local state=$(gh api "repos/${owner}/${repo}/actions/workflows/${WORKFLOW}" | jq -r '.state')
    if [[ $state == "$disabled_manually" ]]; then
      enable_workflow "$owner" "$repo" "$WORKFLOW"
    fi

    set_common_secrets "github"
    gh workflow run "$WORKFLOW"
    echo "Waiting for 90 seconds before disabling workflow..."
    sleep 90
  else
    echo "Actions are not enabled on this repo."
    return 1
  fi
}

if [[ "$LOCAL_MODE" == true ]]; then
  handle_local_workflow
else
  handle_github_workflow
fi
