#!/usr/bin/env bash
set -euo pipefail

RESOURCE_GROUP="${1:-flixtube}"
NAMESPACE="${2:-logging}"

function show_help() {
  cat << EOF
Usage: $0 [OPTIONS] [RESOURCE_GROUP] [NAMESPACE]

Deploy EFK (Elasticsearch, Fluentd, Kibana) stack to an AKS cluster.

ARGUMENTS:
  RESOURCE_GROUP  Azure resource group name (default: flixtube)
  NAMESPACE       Kubernetes namespace for EFK deployment (default: logging)

OPTIONS:
  --help          Show this help message and exit

EXAMPLES:
  $0                              # Deploy EFK to flixtube/logging
  $0 myresourcegroup              # Deploy EFK to myresourcegroup/logging
  $0 myresourcegroup mynamespace  # Deploy EFK to myresourcegroup/mynamespace
  $0 --help                       # Show this help message

EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --help)
      show_help
      exit 0
      ;;
    *)
      # Handle positional arguments for resource group and namespace
      if [[ -z "$RESOURCE_GROUP" ]] || [[ "$RESOURCE_GROUP" == "flixtube" ]]; then
        RESOURCE_GROUP="$1"
      elif [[ -z "$NAMESPACE" ]] || [[ "$NAMESPACE" == "logging" ]]; then
        NAMESPACE="$1"
      fi
      shift
      ;;
  esac
done

if ! command -V kubectl &> /dev/null; then
  echo "kubectl is not installed or available"
  exit 1
fi

if ! command -V az &> /dev/null; then
  echo "az is not installed or available"
  exit 1
fi

az aks get-credentials --resource-group "$RESOURCE_GROUP" --name "$RESOURCE_GROUP"

echo "ğŸ”¹ Creating namespace: ${NAMESPACE}"
kubectl get ns "${NAMESPACE}" > /dev/null 2>&1 || kubectl create ns "${NAMESPACE}"

echo "ğŸ”¹ Deploying Elasticsearch..."
kubectl -n "${NAMESPACE}" apply -f https://raw.githubusercontent.com/fluent/fluentd-kubernetes-daemonset/master/elasticsearch/es-statefulset.yaml
kubectl -n "${NAMESPACE}" apply -f https://raw.githubusercontent.com/fluent/fluentd-kubernetes-daemonset/master/elasticsearch/es-service.yaml

echo "â³ Waiting for Elasticsearch ready..."
kubectl -n "${NAMESPACE}" rollout status statefulset/elasticsearch --timeout=300s

echo "ğŸ”¹ Deploying Kibana..."
kubectl -n "${NAMESPACE}" apply -f https://raw.githubusercontent.com/fluent/fluentd-kubernetes-daemonset/master/kibana/kibana.yaml

echo "â³ Waiting for Kibana ready..."
kubectl -n "${NAMESPACE}" rollout status deployment/kibana --timeout=300s

echo "ğŸ”¹ Deploying Fluentd DaemonSet..."
kubectl -n "${NAMESPACE}" apply -f https://raw.githubusercontent.com/fluent/fluentd-kubernetes-daemonset/master/fluentd-daemonset-elasticsearch.yaml

echo "â³ Waiting for Fluentd ready..."
# Wait for at least one Fluentd pod to be ready
kubectl -n "${NAMESPACE}" wait --for=condition=ready pod \
  -l k8s-app=fluentd-logging --timeout=300s

echo "ğŸ‰ EFK successfully deployed to '${NAMESPACE}' namespace!"

# Optional automatic port-forwarding
echo "ğŸšª Port-forwarding services..."
echo "Kibana â†’ http://localhost:5601"
echo "Elasticsearch â†’ http://localhost:9200"
echo "Press Ctrl+C to stop port-forwarding."

kubectl -n "${NAMESPACE}" port-forward svc/kibana 5601:5601 \
  svc/elasticsearch-logging 9200:9200
