#!/usr/bin/env bash
set -euo pipefail

RESOURCE_GROUP="${1:-flixtube}"
NAMESPACE="${2:-logging}"
CLUSTER_NAME="${RESOURCE_GROUP}" # Defaults cluster name to resource group name

function show_help() {
  echo "Deploy EFK (Elasticsearch + Fluentd + Kibana) to AKS"
  echo "Usage: $0 [RESOURCE_GROUP] [NAMESPACE]"
  exit 0
}

if [[ "${1:-}" == "--help" ]]; then show_help; fi

for cmd in kubectl az helm; do
  command -v $cmd > /dev/null || {
    echo "$cmd missing"
    exit 1
  }
done

echo "â›“ Connecting to AKS: $RESOURCE_GROUP/$CLUSTER_NAME ..."
az aks get-credentials --resource-group "$RESOURCE_GROUP" --name "$CLUSTER_NAME" --overwrite-existing

echo "ğŸ”§ Creating namespace: $NAMESPACE ..."
kubectl get ns "$NAMESPACE" > /dev/null 2>&1 || kubectl create ns "$NAMESPACE"

echo "âš™ï¸ Ensuring vm.max_map_count is correct on all nodes..."
kubectl apply -f - << EOF
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: sysctl-setter
  namespace: kube-system
spec:
  selector:
    matchLabels:
      name: sysctl-setter
  template:
    metadata:
      labels:
        name: sysctl-setter
    spec:
      hostPID: true
      initContainers:
      - name: set-sysctl
        image: busybox
        command:
        - sh
        - -c
        - |
          sysctl -w vm.max_map_count=262144
          echo "vm.max_map_count set to \$(sysctl -n vm.max_map_count)"
        securityContext:
          privileged: true
        volumeMounts:
        - name: host-sys
          mountPath: /host-sys
      containers:
      - name: dummy
        image: busybox
        command: ["sleep", "3600"]
      volumes:
      - name: host-sys
        hostPath:
          path: /sys
EOF

kubectl rollout status daemonset/sysctl-setter -n kube-system --timeout=200s

echo "ğŸ“¦ Adding Bitnami repo ..."
helm repo add bitnami https://charts.bitnami.com/bitnami || true
helm repo update

echo "ğŸ“Œ Deploying Elasticsearch (dev mode, no persistence)"
helm upgrade --install elasticsearch bitnami/elasticsearch \
  --namespace logging \
  --version 19.5.10 \
  --set master.replicas=1 \
  --set data.replicas=1 \
  --set master.persistence.enabled=false \
  --set data.persistence.enabled=false \
  --set volumePermissions.enabled=true \
  --set image.tag=7.17.10-debian-11-r106 \
  --set sysctlImage.tag=11-debian-11-r106

echo "â³ Waiting for ES to be Ready..."
kubectl -n "$NAMESPACE" rollout status statefulset/elasticsearch-master --timeout=400s

echo "ğŸ“Œ Deploying Kibana ..."
helm upgrade --install kibana bitnami/kibana \
  --namespace "$NAMESPACE" \
  --set elasticsearch.hosts="{elasticsearch-master}"

echo "â³ Waiting for Kibana Ready..."
kubectl -n "$NAMESPACE" rollout status deployment/kibana --timeout=400s

echo "ğŸ“Œ Deploying Fluentd DaemonSet ..."
kubectl -n "$NAMESPACE" apply -f \
  https://raw.githubusercontent.com/fluent/fluentd-kubernetes-daemonset/master/fluentd-daemonset-elasticsearch.yaml

kubectl -n "$NAMESPACE" wait \
  --for=condition=ready pod -l k8s-app=fluentd-logging --timeout=300s

echo "âœ¨ EFK successfully deployed to '$NAMESPACE' namespace!"

echo
echo "ğŸšª Port-forwarding for local access..."
echo "  Kibana â†’ http://localhost:5601"
echo "  Elasticsearch â†’ http://localhost:9200"
echo "Press CTRL+C to stop"
echo

kubectl -n "$NAMESPACE" port-forward svc/kibana 5601:5601 \
  svc/elasticsearch-master 9200:9200
