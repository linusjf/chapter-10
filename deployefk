#!/usr/bin/env bash
set -euo pipefail

RESOURCE_GROUP="${1:-flixtube}"
NAMESPACE="${2:-logging}"
CLUSTER_NAME="${RESOURCE_GROUP}" # default: same as RG

show_help() {
  cat << EOF
Usage: $0 [RESOURCE_GROUP] [NAMESPACE]

Deploy secure EFK (Elasticsearch, Fluentd, Kibana) stack to an AKS cluster.

Defaults:
  RESOURCE_GROUP = flixtube
  NAMESPACE      = logging

Examples:
  $0
  $0 my-rg
  $0 my-rg my-namespace
EOF
}

[[ "${1:-}" == "--help" ]] && {
  show_help
  exit 0
}

for cmd in kubectl az helm; do
  command -v "$cmd" > /dev/null 2>&1 || {
    echo "âŒ $cmd not installed or not in PATH" >&2
    exit 1
  }
done

echo "â›“ Fetching AKS credentials (RG='$RESOURCE_GROUP', cluster='$CLUSTER_NAME')..."
az aks get-credentials --resource-group "$RESOURCE_GROUP" --name "$CLUSTER_NAME" --overwrite-existing

echo "ğŸ”§ Ensuring namespace '$NAMESPACE' exists..."
kubectl get ns "$NAMESPACE" > /dev/null 2>&1 || kubectl create ns "$NAMESPACE"

echo "âš™ï¸ Applying vm.max_map_count DaemonSet..."
cat << 'EOF' | kubectl apply -f -
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: vm-max-map-count-setter
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: vm-max-map-count-setter
  template:
    metadata:
      labels:
        app: vm-max-map-count-setter
    spec:
      hostPID: true
      containers:
      - name: sysctl
        image: busybox:latest
        securityContext:
          privileged: true
        command: ["sh", "-c", "sysctl -w vm.max_map_count=262144 || true; sleep 3600"]
EOF

kubectl -n kube-system rollout status daemonset/vm-max-map-count-setter --timeout=120s \
  || echo "âš ï¸ vm.max_map_count DaemonSet timed out (may already be set on nodes)"

echo "ğŸ“¦ Adding Helm repos..."
helm repo add bitnami https://charts.bitnami.com/bitnami > /dev/null 2>&1 || true
helm repo add elastic https://helm.elastic.co > /dev/null 2>&1 || true
helm repo update

echo "ğŸ“Œ Deploying Elasticsearch (Bitnami secured)..."
helm upgrade --install elasticsearch bitnami/elasticsearch \
  --namespace "$NAMESPACE" \
  --set replicas=1 \
  --set master.replicas=1 \
  --set tls.autoGenerated=true \
  --set persistence.enabled=false \
  --set volumePermissions.enabled=true \
  --set resources.requests.cpu=200m \
  --set resources.requests.memory=1Gi \
  --set resources.limits.memory=2Gi

echo "â³ Waiting for Elasticsearch master pod Ready..."
kubectl -n "$NAMESPACE" wait \
  --for=condition=ready pod \
  -l app.kubernetes.io/component=master \
  --timeout=600s

echo "ğŸ”‘ Fetching Elasticsearch password..."
ES_PASSWORD=$(
  kubectl get secret elasticsearch-master-credentials \
    -n "$NAMESPACE" \
    -o jsonpath='{.data.password}' | base64 -d
)

echo "ğŸ” Generating kibana-values.yaml with secure settings..."
cat << EOF > kibana-values.yaml
elasticsearch:
  hosts:
    - "elasticsearch-master"
  port: 9200
  security:
    enabled: true
    elasticsearchPassword: "$ES_PASSWORD"
  tls:
    enabled: true

resources:
  limits:
    memory: 1Gi
  requests:
    cpu: 100m
    memory: 512Mi
EOF

echo "ğŸ“Œ Deploying Kibana (HTTPS + auth)..."
helm upgrade --install kibana bitnami/kibana \
  --namespace "$NAMESPACE" \
  -f kibana-values.yaml

echo "â³ Waiting for Kibana Ready..."
kubectl -n "$NAMESPACE" rollout status deployment/kibana --timeout=600s

echo "ğŸ“Œ Deploying Fluentd DaemonSet..."
kubectl -n "$NAMESPACE" apply -f \
  https://raw.githubusercontent.com/fluent/fluentd-kubernetes-daemonset/master/fluentd-daemonset-elasticsearch.yaml

echo "ğŸ¯ Configuring Fluentd to send logs to Elasticsearch..."
kubectl -n "$NAMESPACE" set env daemonset/fluentd-elasticsearch \
  FLUENT_ELASTICSEARCH_HOST=elasticsearch-master \
  FLUENT_ELASTICSEARCH_PORT=9200

echo "â³ Waiting for Fluentd..."
kubectl -n "$NAMESPACE" wait --for=condition=ready pod \
  -l k8s-app=fluentd-logging --timeout=600s

echo
echo "ğŸ‰ Secure EFK deployed successfully!"
echo
echo "ğŸ” Save these details:"
echo "  Username: elastic"
echo "  Password: $ES_PASSWORD"
echo
echo "ğŸ‘‰ Kibana UI:"
echo "  https://localhost:5601  (via port-forward)"
echo
echo "ğŸšª Starting port-forwardâ€¦ (Ctrl+C to exit)"
kubectl -n "$NAMESPACE" port-forward svc/kibana 5601:5601 \
  svc/elasticsearch-master 9200:9200
