#!/usr/bin/env bash
set -euo pipefail
RESOURCE_GROUP="flixtube"
NAMESPACE="default"
ROLE="admin"

function show_help() {
  cat << EOF
Usage: $0 [OPTIONS] [RESOURCE_GROUP] [NAMESPACE]

Deploy Kubernetes Dashboard to an AKS cluster and set up admin access.

ARGUMENTS:
  RESOURCE_GROUP  Azure resource group name (default: flixtube)
  NAMESPACE       Kubernetes namespace (default: default)

OPTIONS:
  --role ROLE     Role to create: admin or readonly (default: admin)
  --help          Show this help message and exit

EXAMPLES:
  $0                              # Deploy dashboard with admin role to flixtube/default
  $0 --role readonly              # Deploy dashboard with readonly role to flixtube/default
  $0 myresourcegroup --role admin # Deploy dashboard with admin role to myresourcegroup/default
  $0 myresourcegroup mynamespace --role readonly  # Deploy dashboard with readonly role
  $0 --help                       # Show this help message

EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --role)
      ROLE="$2"
      if [[ "$ROLE" != "admin" && "$ROLE" != "readonly" ]]; then
        echo "Error: --role must be either 'admin' or 'readonly'"
        exit 1
      fi
      shift 2
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      # Handle positional arguments for resource group and namespace
      if [[ -z "$RESOURCE_GROUP" ]] || [[ "$RESOURCE_GROUP" == "flixtube" ]]; then
        RESOURCE_GROUP="$1"
      elif [[ -z "$NAMESPACE" ]] || [[ "$NAMESPACE" == "default" ]]; then
        NAMESPACE="$1"
      fi
      shift
      ;;
  esac
done

if ! command -V kubectl &> /dev/null; then
  echo "kubectl is not installed or available"
  exit 1
fi

if ! command -V az &> /dev/null; then
  echo "az is not installed or available"
  exit 1
fi
az aks get-credentials --resource-group "$RESOURCE_GROUP" --name "$RESOURCE_GROUP"

kubectl get namespaces | grep 'kubernetes-dashboard' && kubectl delete namespace kubernetes-dashboard
kubectl create namespace kubernetes-dashboard --save-config

kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml

sleep 10

kubectl -n kubernetes-dashboard get pods
kubectl -n kubernetes-dashboard get svc

if [[ "$ROLE" == "admin" ]]; then
  echo "Applying admin role configuration..."
  kubectl apply -f dashboard-adminuser.yaml
  USER_NAME="admin-user"
  SECRET_NAME="admin-user"
else
  echo "Applying readonly role configuration..."
  kubectl apply -f dashboard-readonlyuser.yaml
  USER_NAME="readonly-user"
  SECRET_NAME="readonly-user"
fi

kubectl -n kubernetes-dashboard create token "$USER_NAME"

kubectl get secret "$SECRET_NAME" -n kubernetes-dashboard -o jsonpath="{.data.token}" | base64 -d

kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard 8443:443
