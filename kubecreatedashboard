#!/usr/bin/env bash

RESOURCE_GROUP="${1:-flixtube}"
NAMESPACE="${2:-default}"

function show_help() {
  cat <<EOF
Usage: $0 [OPTIONS] [RESOURCE_GROUP] [NAMESPACE]

Deploy Kubernetes Dashboard to an AKS cluster and set up admin access.

ARGUMENTS:
  RESOURCE_GROUP  Azure resource group name (default: flixtube)
  NAMESPACE       Kubernetes namespace (default: default)

OPTIONS:
  --help          Show this help message and exit

EXAMPLES:
  $0                              # Deploy dashboard to flixtube/default
  $0 myresourcegroup              # Deploy dashboard to myresourcegroup/default
  $0 myresourcegroup mynamespace  # Deploy dashboard to myresourcegroup/mynamespace
  $0 --help                       # Show this help message

EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
  --help)
    show_help
    exit 0
    ;;
  *)
    # Handle positional arguments for resource group and namespace
    if [[ -z "$RESOURCE_GROUP" ]] || [[ "$RESOURCE_GROUP" == "flixtube" ]]; then
      RESOURCE_GROUP="$1"
    elif [[ -z "$NAMESPACE" ]] || [[ "$NAMESPACE" == "default" ]]; then
      NAMESPACE="$1"
    fi
    shift
    ;;
  esac
done

if ! command -V kubectl &>/dev/null; then
  "kubectl is not installed or available"
fi

if ! command -V az &>/dev/null; then
  "az is not installed or available"
fi
az aks get-credentials --resource-group "$RESOURCE_GROUP" --name "$RESOURCE_GROUP"

kubectl create namespace kubernetes-dashboard
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml

sleep 10

kubectl -n kubernetes-dashboard get pods
kubectl -n kubernetes-dashboard get svc

kubectl apply -f dashboard-adminuser.yaml

kubectl -n kubernetes-dashboard create token admin-user

kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard 8443:443
