#!/usr/bin/env bash
set -euo pipefail
RESOURCE_GROUP="flixtube"
NAMESPACE="default"
TOKEN=""

function show_help() {
  cat << EOF
Usage: $0 [OPTIONS] [RESOURCE_GROUP] [NAMESPACE]

Install Groundcover monitoring to an AKS cluster.

ARGUMENTS:
  RESOURCE_GROUP  Azure resource group name (default: flixtube)
  NAMESPACE       Kubernetes namespace (default: default)

OPTIONS:
  --token TOKEN   Groundcover deployment token (required)
  --help          Show this help message and exit

EXAMPLES:
  $0 --token mytoken123                    # Install to flixtube/default with token
  $0 myresourcegroup --token mytoken123    # Install to myresourcegroup/default with token
  $0 myresourcegroup mynamespace --token mytoken123  # Install with custom resource group and namespace
  $0 --help                                # Show this help message

EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --token)
      TOKEN="$2"
      shift 2
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      # Handle positional arguments for resource group and namespace
      if [[ -z "$RESOURCE_GROUP" ]] || [[ "$RESOURCE_GROUP" == "flixtube" ]]; then
        RESOURCE_GROUP="$1"
      elif [[ -z "$NAMESPACE" ]] || [[ "$NAMESPACE" == "default" ]]; then
        NAMESPACE="$1"
      fi
      shift
      ;;
  esac
done

if ! command -V groundcover &> /dev/null; then
  echo "groundcover is not installed or available"
  exit 1
fi

if ! command -V az &> /dev/null; then
  echo "az is not installed or available"
  exit 1
fi

# Check if token is provided
if [[ -z "$TOKEN" ]]; then
  echo "Error: --token option is required"
  echo ""
  show_help
  exit 1
fi

az aks get-credentials --resource-group "$RESOURCE_GROUP" --name "$RESOURCE_GROUP"

groundcover deploy --token "$TOKEN"
